---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { SITE } from "../../config/site";
import AdSlot from "../../components/AdSlot.astro";
import { GUIDES } from "../../lib/guides.generated";
import { withTrailingSlash } from "../../lib/url";

const title = `Guides | ${SITE.name}`;
const description =
  "Practical guides for estimating cloud spend: egress, logs, storage, networking, CDN, and Kubernetes capacity.";
const slots = SITE.adsenseSlots;

const grouped = GUIDES.reduce<Record<string, typeof GUIDES>>((acc, g) => {
  (acc[g.category] ||= []).push(g);
  return acc;
}, {});
const categories = Object.entries(grouped).sort(([a], [b]) => a.localeCompare(b));
---
<BaseLayout title={title} description={description} canonicalPath="/guides">
  <section class="card hero">
    <h1>Guides</h1>
    <p>Estimation workflows, unit pitfalls, and checklists to avoid surprise cloud bills.</p>
    <div class="btn-row" style="margin-top:12px">
      <a class="btn" href="/calculators/">Tools</a>
      <a class="btn" href="/guides/aws/">AWS</a>
      <a class="btn" href="/guides/azure/">Azure</a>
      <a class="btn" href="/guides/gcp/">GCP</a>
      <a class="btn" href="/guides/egress-costs/">Egress</a>
      <a class="btn" href="/guides/log-costs/">Logs</a>
      <a class="btn" href="/guides/cdn-costs/">CDN</a>
      <a class="btn" href="/guides/metrics-costs/">Metrics</a>
      <a class="btn" href="/guides/database-costs/">Databases</a>
      <a class="btn" href="/guides/messaging-costs/">Messaging</a>
      <a class="btn" href="/guides/kubernetes-costs/">Kubernetes</a>
      <a class="btn" href="/guides/networking-costs/">Networking</a>
      <a class="btn" href="/guides/security-costs/">Security</a>
      <a class="btn" href="/guides/load-balancing-costs/">Load balancing</a>
      <a class="btn" href="/guides/requests-costs/">Requests</a>
      <a class="btn" href="/guides/serverless-costs/">Serverless</a>
      <a class="btn" href="/guides/compute-costs/">Compute</a>
      <a class="btn" href="/guides/observability-costs/">Observability</a>
      <a class="btn" href="/guides/backups-and-snapshots-costs/">Backups</a>
      <a class="btn" href="/sitemap/">Sitemap</a>
    </div>
  </section>

  <section class="grid" style="margin-top:18px">
    <section class="card section prose col-6">
      <h2 style="margin-top:0">How to use these guides</h2>
      <ol class="muted" style="margin:10px 0 0; padding-left:18px">
        <li>Start with a measurable driver (requests/month, GB/month, hours, GB-month).</li>
        <li>Use a calculator for the first estimate, then return to the guide for pitfalls and validation.</li>
        <li>Validate with a real week of billing/metrics before “optimizing” pricing tiers.</li>
      </ol>
      <div class="btn-row" style="margin-top:12px">
        <a class="btn" href="/guides/cloud-cost-estimation-checklist/">Estimation checklist</a>
        <a class="btn" href="/methodology/">Methodology</a>
        <a class="btn" href="/calculators/">Tools</a>
      </div>
    </section>

    <section class="card section prose col-6">
      <h2 style="margin-top:0">Suggested starting points</h2>
      <ul class="muted" style="margin:10px 0 0; padding-left:18px">
        <li>
          <a href="/guides/egress-costs/">Egress costs</a>: separate CDN bandwidth from origin egress.
        </li>
        <li>
          <a href="/guides/log-costs/">Log costs</a>: ingestion + retention first, then scan/query.
        </li>
        <li>
          <a href="/guides/storage-costs/">Storage costs</a>: GB-month + requests + replication/copies + egress.
        </li>
        <li>
          <a href="/guides/kubernetes-costs/">Kubernetes costs</a>: nodes plus the non-node line items.
        </li>
      </ul>
      <div class="btn-row" style="margin-top:12px">
        <a class="btn" href="/calculators/networking/">Networking calculators</a>
        <a class="btn" href="/calculators/logging/">Logging calculators</a>
        <a class="btn" href="/calculators/storage/">Storage calculators</a>
      </div>
    </section>
  </section>

  <section class="card section" style="margin-top:18px" id="guides-filter">
    <div class="form" style="align-items:end">
      <div class="field field-3">
        <div class="label"><label for="guides-q">Search</label></div>
        <input id="guides-q" type="search" placeholder="egress, cloudfront, eks, s3..." autocomplete="off" />
      </div>
      <div class="field field-3">
        <div class="label"><label for="guides-cat">Category</label></div>
        <select id="guides-cat">
          <option value="all">All categories</option>
          {categories.map(([category]) => (
            <option value={category}>{category}</option>
          ))}
        </select>
      </div>
      <div class="field field-6">
        <div class="btn-row" style="justify-content:space-between; width:100%">
          <div class="muted" id="guides-count" aria-live="polite" style="font-size:13px"></div>
          <button class="btn" type="button" id="guides-clear">Clear</button>
        </div>
      </div>
    </div>
  </section>

  <section style="margin-top:18px">
    {categories.map(([category, guides]) => (
      <div style="margin-bottom:16px" class="guide-group" data-category={category}>
        <div class="pill guide-group-title" style="margin: 6px 0 10px">{category}</div>
        <div class="grid">
          {guides
            .slice()
            .sort((a, b) => a.title.localeCompare(b.title))
            .map((g) => (
              <a
                class="card2 tool col-6 guide-card"
                href={withTrailingSlash(g.canonicalPath)}
                data-category={g.category}
                data-title={g.title}
                data-desc={g.description}
                data-slug={g.slug}
              >
                <div class="tool-title">{g.title}</div>
                <div class="tool-desc">{g.description}</div>
              </a>
            ))}
        </div>
      </div>
    ))}
  </section>

  <section class="section">
    <AdSlot slot={slots.guidesMid} minHeight={280} />
  </section>

  <script is:inline type="text/javascript">
    (function () {
      var filterRoot = document.getElementById("guides-filter");
      if (!filterRoot) return;

      var qEl = document.getElementById("guides-q");
      var catEl = document.getElementById("guides-cat");
      var countEl = document.getElementById("guides-count");
      var clearEl = document.getElementById("guides-clear");
      if (!qEl || !catEl || !countEl || !clearEl) return;

      var cards = Array.prototype.slice.call(document.querySelectorAll(".guide-card"));
      var groups = Array.prototype.slice.call(document.querySelectorAll(".guide-group"));
      var total = cards.length;

      function norm(s) {
        return String(s || "").toLowerCase().trim();
      }

      function setCount(visible) {
        countEl.textContent = "Showing " + visible + " of " + total + " guides";
      }

      function apply() {
        var q = norm(qEl.value);
        var cat = catEl.value || "all";

        var visible = 0;
        cards.forEach(function (card) {
          var title = norm(card.getAttribute("data-title"));
          var desc = norm(card.getAttribute("data-desc"));
          var slug = norm(card.getAttribute("data-slug"));
          var cardCat = card.getAttribute("data-category") || "";
          var matchCat = cat === "all" ? true : cardCat === cat;
          var matchQ = !q ? true : title.indexOf(q) !== -1 || desc.indexOf(q) !== -1 || slug.indexOf(q) !== -1;
          var show = matchCat && matchQ;
          card.hidden = !show;
          if (show) visible++;
        });

        groups.forEach(function (g) {
          var any = false;
          var groupCards = g.querySelectorAll(".guide-card");
          for (var i = 0; i < groupCards.length; i++) {
            if (!groupCards[i].hidden) {
              any = true;
              break;
            }
          }
          g.hidden = !any;
        });

        setCount(visible);

        try {
          var url = new URL(window.location.href);
          if (q) url.searchParams.set("q", q);
          else url.searchParams.delete("q");
          if (cat && cat !== "all") url.searchParams.set("cat", cat);
          else url.searchParams.delete("cat");
          window.history.replaceState({}, "", url.toString());
        } catch (e) {}
      }

      function initFromQuery() {
        try {
          var url = new URL(window.location.href);
          var q = url.searchParams.get("q");
          var cat = url.searchParams.get("cat");
          if (q) qEl.value = q;
          if (cat) catEl.value = cat;
        } catch (e) {}
      }

      qEl.addEventListener("input", apply);
      catEl.addEventListener("change", apply);
      clearEl.addEventListener("click", function () {
        qEl.value = "";
        catEl.value = "all";
        apply();
        try { qEl.focus(); } catch (e) {}
      });

      initFromQuery();
      apply();
    })();
  </script>
</BaseLayout>
