---
import BaseLayout from "./BaseLayout.astro";
import AdSlot from "../components/AdSlot.astro";
import { SITE } from "../config/site";
import { withTrailingSlash } from "../lib/url";
import { GUIDES } from "../lib/guides.generated";
import { TOOLS } from "../lib/tools";

type FAQ = { q: string; a: string };
type RelatedLink = { href: string; label: string };

type Props = {
  title: string;
  description: string;
  canonicalPath: string;
  intro: string;
  how: string[];
  faqs: FAQ[];
  lastUpdated: string;
  includes?: string[];
  excludes?: string[];
  examples?: string[];
  related?: RelatedLink[];
};

const {
  title,
  description,
  canonicalPath,
  intro,
  how,
  faqs,
  lastUpdated,
  includes,
  excludes,
  examples,
  related,
} = Astro.props;
const slots = SITE.adsenseSlots;
const siteUrl = Astro.site ? Astro.site.toString() : SITE.url;
const normalizedCanonicalPath = withTrailingSlash(canonicalPath);
const canonical = new URL(normalizedCanonicalPath, siteUrl).toString();
const toolIndexUrl = new URL("/calculators/", siteUrl).toString();
const toolSlug = canonicalPath.replace(/^\/calculators\//, "").replace(/\/+$/, "");
const tool = TOOLS.find((t) => t.slug === toolSlug) ?? null;

function tokenize(input: string) {
  const stop = new Set([
    "a",
    "an",
    "and",
    "are",
    "as",
    "at",
    "by",
    "calculator",
    "cost",
    "costs",
    "estimate",
    "estimating",
    "estimation",
    "for",
    "from",
    "how",
    "in",
    "is",
    "it",
    "of",
    "on",
    "or",
    "pricing",
    "to",
    "what",
    "with",
  ]);

  return Array.from(
    new Set(
      String(input || "")
        .toLowerCase()
        .split(/[^a-z0-9]+/g)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3 && !stop.has(t)),
    ),
  );
}

function overlapCount(a: string[], b: string[]) {
  if (!a.length || !b.length) return 0;
  const set = new Set(a);
  let count = 0;
  for (const item of b) if (set.has(item)) count++;
  return count;
}

const categoryToTopics: Record<string, string[]> = {
  Networking: ["egress", "cdn", "requests", "load-balancing"],
  Logging: ["logging", "metrics"],
  Storage: ["storage", "database"],
  Kubernetes: ["kubernetes"],
  FinOps: ["requests", "storage", "egress"],
  Units: ["egress"],
};

const inferredTopics = new Set<string>(categoryToTopics[tool?.category ?? ""] ?? []);
const slugLower = toolSlug.toLowerCase();
if (slugLower.includes("cdn") || slugLower.includes("cloudfront")) inferredTopics.add("cdn");
if (slugLower.includes("log")) inferredTopics.add("logging");
if (slugLower.includes("metric") || slugLower.includes("alarm")) inferredTopics.add("metrics");
if (slugLower.includes("kubernetes") || slugLower.includes("eks")) inferredTopics.add("kubernetes");
if (slugLower.includes("db") || slugLower.includes("database") || slugLower.includes("rds")) inferredTopics.add("database");
if (slugLower.includes("sqs") || slugLower.includes("sns") || slugLower.includes("pubsub")) inferredTopics.add("messaging");
if (slugLower.includes("waf") || slugLower.includes("kms") || slugLower.includes("secrets")) inferredTopics.add("security");
if (slugLower.includes("egress") || slugLower.includes("transfer") || slugLower.includes("nat")) inferredTopics.add("egress");
if (slugLower.includes("request") || slugLower.includes("rps")) inferredTopics.add("requests");

const calcTokens = tokenize(`${toolSlug} ${title}`);
const calcTopics = Array.from(inferredTopics);
const relatedGuides = GUIDES.map((g) => {
  const tokenOverlap = overlapCount(calcTokens, tokenize(`${g.slug} ${g.title}`));
  const topicOverlap = overlapCount(calcTopics, g.topics ?? []);
  const score = topicOverlap * 3 + tokenOverlap;
  return { guide: g, score };
})
  .filter((x) => x.score > 0)
  .sort((a, b) => b.score - a.score || a.guide.title.localeCompare(b.guide.title))
  .slice(0, 6)
  .map((x) => x.guide);
const breadcrumbSchema = {
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", siteUrl).toString() },
    { "@type": "ListItem", position: 2, name: "Tools", item: toolIndexUrl },
    { "@type": "ListItem", position: 3, name: title, item: canonical },
  ],
};
const faqSchema =
  faqs && faqs.length
    ? {
        "@type": "FAQPage",
        url: canonical,
        mainEntity: faqs.map((f) => ({
          "@type": "Question",
          name: f.q,
          acceptedAnswer: { "@type": "Answer", text: f.a },
        })),
      }
    : null;
const schemas = [breadcrumbSchema, faqSchema].filter(Boolean);
---
<BaseLayout title={title} description={description} canonicalPath={normalizedCanonicalPath}>
  {schemas.length ? (
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({ "@context": "https://schema.org", "@graph": schemas })}
    />
  ) : null}
  <section class="card hero">
    <h1>{title}</h1>
    <p>{intro}</p>
    <div class="btn-row" style="margin-top:12px; align-items:center">
      <button class="btn" type="button" id="copy-share-link">Copy share link</button>
      <span class="muted" id="copy-share-link-status" aria-live="polite" style="font-size:13px"></span>
    </div>
  </section>

  <script is:inline type="text/javascript">
    (function () {
      var btn = document.getElementById("copy-share-link");
      var status = document.getElementById("copy-share-link-status");
      if (!btn) return;
      function setStatus(msg) {
        if (!status) return;
        status.textContent = msg || "";
      }
      btn.addEventListener("click", function () {
        try {
          var url = window.location.href;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(url)
              .then(function () {
                setStatus("Copied");
                setTimeout(function () {
                  setStatus("");
                }, 1200);
              })
              .catch(function () {
                window.prompt("Copy link:", url);
              });
          } else {
            window.prompt("Copy link:", url);
          }
        } catch (e) {}
      });
    })();
  </script>

  <section class="card section">
    <slot />
  </section>

  <section class="section">
    <AdSlot slot={slots.calculatorMid} minHeight={280} />
  </section>

  {examples && examples.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Example scenario</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {examples.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  {includes && includes.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Included</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {includes.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  {excludes && excludes.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Not included</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {excludes.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  <section class="card section prose">
    <h2 style="margin-top:0">How we calculate</h2>
    <ul class="muted" style="margin:8px 0 0; padding-left:18px">
      {how.map((line) => (
        <li>{line}</li>
      ))}
    </ul>
  </section>

  <section class="card section prose">
    <h2 style="margin-top:0">FAQ</h2>
    {faqs.map((f) => (
      <details class="card2" style="padding:12px; margin:10px 0">
        <summary style="cursor:pointer; font-weight:800">{f.q}</summary>
        <div class="muted" style="margin-top:8px">{f.a}</div>
      </details>
    ))}
  </section>

  {related && related.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Related tools</h2>
      <div class="btn-row" style="margin-top:0">
        {related.map((r) => (
          <a class="btn" href={withTrailingSlash(r.href)}>
            {r.label}
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {relatedGuides.length ? (
    <section class="card section">
      <h2 style="margin-top:0">Related guides</h2>
      <div class="grid">
        {relatedGuides.map((g) => (
          <a class="card2 tool col-6" href={withTrailingSlash(g.canonicalPath)}>
            <div class="tool-title">{g.title}</div>
            <div class="tool-desc">{g.description}</div>
          </a>
        ))}
      </div>
    </section>
  ) : null}

  <section class="section">
    <AdSlot slot={slots.calculatorBottom} minHeight={280} />
  </section>

  <section class="card section prose">
    <h2 style="margin-top:0">Disclaimer</h2>
    <p class="muted" style="margin:0">
      Educational use only. Not legal, financial, or professional advice. Results are estimates based on the inputs and
      assumptions shown on this page. Verify pricing and limits with your providers and documentation.
    </p>
    <p class="muted" style="margin:10px 0 0">Last updated: {lastUpdated}</p>
  </section>
</BaseLayout>
