---
import BaseLayout from "./BaseLayout.astro";
import AdSlot from "../components/AdSlot.astro";
import { SITE } from "../config/site";
import { withTrailingSlash } from "../lib/url";
import { GUIDES } from "../lib/guides.generated";
import { TOOLS } from "../lib/tools";

type FAQ = { q: string; a: string };
type RelatedLink = { href: string; label: string };

type Props = {
  title: string;
  description: string;
  canonicalPath: string;
  intro: string;
  how: string[];
  faqs: FAQ[];
  lastUpdated: string;
  includes?: string[];
  excludes?: string[];
  examples?: string[];
  related?: RelatedLink[];
};

const {
  title,
  description,
  canonicalPath,
  intro,
  how,
  faqs,
  lastUpdated,
  includes,
  excludes,
  examples,
  related,
} = Astro.props;
const slots = SITE.adsenseSlots;
const siteUrl = Astro.site ? Astro.site.toString() : SITE.url;
const normalizedCanonicalPath = withTrailingSlash(canonicalPath);
const canonical = new URL(normalizedCanonicalPath, siteUrl).toString();
const toolIndexUrl = new URL("/calculators/", siteUrl).toString();
const toolSlug = canonicalPath.replace(/^\/calculators\//, "").replace(/\/+$/, "");
const tool = TOOLS.find((t) => t.slug === toolSlug) ?? null;

function tokenize(input: string) {
  const stop = new Set([
    "a",
    "an",
    "and",
    "are",
    "as",
    "at",
    "by",
    "calculator",
    "cost",
    "costs",
    "estimate",
    "estimating",
    "estimation",
    "for",
    "from",
    "how",
    "in",
    "is",
    "it",
    "of",
    "on",
    "or",
    "pricing",
    "to",
    "what",
    "with",
  ]);

  return Array.from(
    new Set(
      String(input || "")
        .toLowerCase()
        .split(/[^a-z0-9]+/g)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3 && !stop.has(t)),
    ),
  );
}

function overlapCount(a: string[], b: string[]) {
  if (!a.length || !b.length) return 0;
  const set = new Set(a);
  let count = 0;
  for (const item of b) if (set.has(item)) count++;
  return count;
}

const categoryToTopics: Record<string, string[]> = {
  Networking: ["egress", "cdn", "requests", "load-balancing"],
  Logging: ["logging", "metrics"],
  Storage: ["storage", "database"],
  Kubernetes: ["kubernetes"],
  FinOps: ["requests", "storage", "egress"],
  Units: ["egress"],
};

const inferredTopics = new Set<string>(categoryToTopics[tool?.category ?? ""] ?? []);
const slugLower = toolSlug.toLowerCase();
if (slugLower.includes("cdn") || slugLower.includes("cloudfront")) inferredTopics.add("cdn");
if (slugLower.includes("log")) inferredTopics.add("logging");
if (slugLower.includes("metric") || slugLower.includes("alarm")) inferredTopics.add("metrics");
if (slugLower.includes("kubernetes") || slugLower.includes("eks")) inferredTopics.add("kubernetes");
if (slugLower.includes("db") || slugLower.includes("database") || slugLower.includes("rds")) inferredTopics.add("database");
if (slugLower.includes("sqs") || slugLower.includes("sns") || slugLower.includes("pubsub")) inferredTopics.add("messaging");
if (slugLower.includes("waf") || slugLower.includes("kms") || slugLower.includes("secrets")) inferredTopics.add("security");
if (slugLower.includes("egress") || slugLower.includes("transfer") || slugLower.includes("nat")) inferredTopics.add("egress");
if (slugLower.includes("request") || slugLower.includes("rps")) inferredTopics.add("requests");

const calcTokens = tokenize(`${toolSlug} ${title}`);
const calcTopics = Array.from(inferredTopics);
const relatedGuides = GUIDES.map((g) => {
  const tokenOverlap = overlapCount(calcTokens, tokenize(`${g.slug} ${g.title}`));
  const topicOverlap = overlapCount(calcTopics, g.topics ?? []);
  const score = topicOverlap * 3 + tokenOverlap;
  return { guide: g, score };
})
  .filter((x) => x.score > 0)
  .sort((a, b) => b.score - a.score || a.guide.title.localeCompare(b.guide.title))
  .slice(0, 6)
  .map((x) => x.guide);
const breadcrumbSchema = {
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", siteUrl).toString() },
    { "@type": "ListItem", position: 2, name: "Tools", item: toolIndexUrl },
    { "@type": "ListItem", position: 3, name: title, item: canonical },
  ],
};
const faqSchema =
  faqs && faqs.length
    ? {
        "@type": "FAQPage",
        url: canonical,
        mainEntity: faqs.map((f) => ({
          "@type": "Question",
          name: f.q,
          acceptedAnswer: { "@type": "Answer", text: f.a },
        })),
      }
    : null;
const schemas = [breadcrumbSchema, faqSchema].filter(Boolean);
---
<BaseLayout title={title} description={description} canonicalPath={normalizedCanonicalPath}>
  {schemas.length ? (
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({ "@context": "https://schema.org", "@graph": schemas })}
    />
  ) : null}
  <section class="card hero">
    <h1>{title}</h1>
    <p>{intro}</p>
    <section id="calc-toolbar" class="btn-row" style="margin-top:12px; align-items:center">
      <button class="btn" type="button" id="calc-copy-link">Copy link</button>
      <button class="btn" type="button" id="calc-reset">Reset</button>
      <button class="btn" type="button" id="calc-save">Save scenario</button>
      <button class="btn" type="button" id="calc-copy-inputs">Copy inputs</button>
      <span class="muted" id="calc-toolbar-status" aria-live="polite" style="font-size:13px"></span>
    </section>

    <div id="calc-scenarios" class="muted" style="margin-top:10px; font-size:13px; display:none">
      <div style="font-weight:800; margin-bottom:6px">Saved scenarios</div>
      <div id="calc-scenarios-list"></div>
    </div>
  </section>

  <script is:inline type="text/javascript">
    (function () {
      var btnCopy = document.getElementById("calc-copy-link");
      var btnReset = document.getElementById("calc-reset");
      var btnSave = document.getElementById("calc-save");
      var btnCopyInputs = document.getElementById("calc-copy-inputs");
      var status = document.getElementById("calc-toolbar-status");
      var scenariosWrap = document.getElementById("calc-scenarios");
      var scenariosList = document.getElementById("calc-scenarios-list");
      if (!btnCopy) return;
      function setStatus(msg) {
        if (!status) return;
        status.textContent = msg || "";
      }
      function toast(msg) {
        setStatus(msg);
        setTimeout(function () {
          setStatus("");
        }, 1200);
      }
      function copyText(text) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
        } catch (e) {}
        try {
          window.prompt("Copy:", text);
        } catch (e) {}
        return Promise.resolve();
      }
      function storageKeyForScenarios(pathname) {
        return "cck:calc:scenarios:" + String(pathname || "/");
      }
      function loadScenarios() {
        try {
          var raw = window.localStorage.getItem(storageKeyForScenarios(window.location.pathname));
          if (!raw) return [];
          var parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed.filter(function (x) {
            return x && typeof x === "object" && typeof x.url === "string";
          });
        } catch (e) {
          return [];
        }
      }
      function saveScenarios(list) {
        try {
          window.localStorage.setItem(storageKeyForScenarios(window.location.pathname), JSON.stringify(list || []));
        } catch (e) {}
      }
      function renderScenarios() {
        if (!scenariosWrap || !scenariosList) return;
        var items = loadScenarios();
        if (!items.length) {
          scenariosWrap.style.display = "none";
          scenariosList.innerHTML = "";
          return;
        }
        scenariosWrap.style.display = "";
        var html = items
          .slice()
          .sort(function (a, b) {
            return (b.createdAt || 0) - (a.createdAt || 0);
          })
          .slice(0, 8)
          .map(function (s, idx) {
            var name = String(s.name || "Scenario " + (idx + 1));
            var safeName = name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return (
              '<div style="display:flex; gap:10px; align-items:center; margin:4px 0">' +
              '<span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">' +
              safeName +
              "</span>" +
              '<a href="' +
              s.url +
              '" style="text-decoration:underline">Open</a>' +
              '<button type="button" data-del="' +
              encodeURIComponent(s.url) +
              '" style="background:transparent; border:0; color:rgba(255,255,255,0.8); cursor:pointer; text-decoration:underline">Delete</button>' +
              "</div>"
            );
          })
          .join("");
        scenariosList.innerHTML = html;

        var delButtons = scenariosList.querySelectorAll("button[data-del]");
        for (var i = 0; i < delButtons.length; i++) {
          delButtons[i].addEventListener("click", function (e) {
            try {
              var u = decodeURIComponent(String(e.target && e.target.getAttribute("data-del") || ""));
              var next = loadScenarios().filter(function (s) {
                return s && s.url !== u;
              });
              saveScenarios(next);
              renderScenarios();
              toast("Deleted");
            } catch (err) {}
          });
        }
      }

      btnCopy.addEventListener("click", function () {
        var url = window.location.href;
        copyText(url)
          .then(function () {
            toast("Copied");
          })
          .catch(function () {
            window.prompt("Copy link:", url);
          });
      });

      if (btnCopyInputs) {
        btnCopyInputs.addEventListener("click", function () {
          try {
            var url = new URL(window.location.href);
            var inputs = {};
            url.searchParams.forEach(function (v, k) {
              inputs[k] = v;
            });
            var payload = JSON.stringify(
              {
                tool: window.location.pathname,
                createdAt: new Date().toISOString(),
                inputs: inputs,
              },
              null,
              2,
            );
            copyText(payload).then(function () {
              toast("Copied");
            });
          } catch (e) {}
        });
      }

      if (btnReset) {
        btnReset.addEventListener("click", function () {
          try {
            var pathname = window.location.pathname;
            try {
              var prefix = "cck:calc:" + pathname + ":";
              for (var i = window.localStorage.length - 1; i >= 0; i--) {
                var k = window.localStorage.key(i);
                if (k && k.indexOf(prefix) === 0) window.localStorage.removeItem(k);
              }
            } catch (e) {}
            window.location.assign(pathname);
          } catch (e) {}
        });
      }

      if (btnSave) {
        btnSave.addEventListener("click", function () {
          try {
            var name = window.prompt("Scenario name:", "");
            if (!name) return;
            var url = window.location.href;
            var items = loadScenarios();
            var existing = items.filter(function (s) {
              return s && s.url === url;
            });
            if (existing.length) {
              existing[0].name = name;
              existing[0].createdAt = Date.now();
              saveScenarios(items);
              renderScenarios();
              toast("Updated");
              return;
            }
            items.push({ name: name, url: url, createdAt: Date.now() });
            items = items.slice().sort(function (a, b) {
              return (b.createdAt || 0) - (a.createdAt || 0);
            });
            if (items.length > 30) items = items.slice(0, 30);
            saveScenarios(items);
            renderScenarios();
            toast("Saved");
          } catch (e) {}
        });
      }

      renderScenarios();
    })();
  </script>

  <section class="card section">
    <slot />
  </section>

  <section class="section">
    <AdSlot slot={slots.calculatorMid} minHeight={280} />
  </section>

  {examples && examples.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Example scenario</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {examples.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  {includes && includes.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Included</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {includes.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  {excludes && excludes.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Not included</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {excludes.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  <section class="card section prose">
    <h2 style="margin-top:0">How we calculate</h2>
    <ul class="muted" style="margin:8px 0 0; padding-left:18px">
      {how.map((line) => (
        <li>{line}</li>
      ))}
    </ul>
  </section>

  <section class="card section prose">
    <h2 style="margin-top:0">FAQ</h2>
    {faqs.map((f) => (
      <details class="card2" style="padding:12px; margin:10px 0">
        <summary style="cursor:pointer; font-weight:800">{f.q}</summary>
        <div class="muted" style="margin-top:8px">{f.a}</div>
      </details>
    ))}
  </section>

  {related && related.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Related tools</h2>
      <div class="btn-row" style="margin-top:0">
        {related.map((r) => (
          <a class="btn" href={withTrailingSlash(r.href)}>
            {r.label}
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {relatedGuides.length ? (
    <section class="card section">
      <h2 style="margin-top:0">Related guides</h2>
      <div class="grid">
        {relatedGuides.map((g) => (
          <a class="card2 tool col-6" href={withTrailingSlash(g.canonicalPath)}>
            <div class="tool-title">{g.title}</div>
            <div class="tool-desc">{g.description}</div>
          </a>
        ))}
      </div>
    </section>
  ) : null}

  <section class="section">
    <AdSlot slot={slots.calculatorBottom} minHeight={280} />
  </section>

  <section class="card section prose">
    <h2 style="margin-top:0">Disclaimer</h2>
    <p class="muted" style="margin:0">
      Educational use only. Not legal, financial, or professional advice. Results are estimates based on the inputs and
      assumptions shown on this page. Verify pricing and limits with your providers and documentation.
    </p>
    <p class="muted" style="margin:10px 0 0">Last updated: {lastUpdated}</p>
  </section>
</BaseLayout>
