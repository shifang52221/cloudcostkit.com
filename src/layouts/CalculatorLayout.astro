---
import BaseLayout from "./BaseLayout.astro";
import AdSlot from "../components/AdSlot.astro";
import { SITE } from "../config/site";
import { withTrailingSlash } from "../lib/url";

type FAQ = { q: string; a: string };
type RelatedLink = { href: string; label: string };

type Props = {
  title: string;
  description: string;
  canonicalPath: string;
  intro: string;
  how: string[];
  faqs: FAQ[];
  lastUpdated: string;
  includes?: string[];
  excludes?: string[];
  examples?: string[];
  related?: RelatedLink[];
};

const {
  title,
  description,
  canonicalPath,
  intro,
  how,
  faqs,
  lastUpdated,
  includes,
  excludes,
  examples,
  related,
} = Astro.props;
const slots = SITE.adsenseSlots;
const siteUrl = Astro.site ? Astro.site.toString() : SITE.url;
const normalizedCanonicalPath = withTrailingSlash(canonicalPath);
const canonical = new URL(normalizedCanonicalPath, siteUrl).toString();
const toolIndexUrl = new URL("/calculators/", siteUrl).toString();
const breadcrumbSchema = {
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", siteUrl).toString() },
    { "@type": "ListItem", position: 2, name: "Tools", item: toolIndexUrl },
    { "@type": "ListItem", position: 3, name: title, item: canonical },
  ],
};
const faqSchema =
  faqs && faqs.length
    ? {
        "@type": "FAQPage",
        url: canonical,
        mainEntity: faqs.map((f) => ({
          "@type": "Question",
          name: f.q,
          acceptedAnswer: { "@type": "Answer", text: f.a },
        })),
      }
    : null;
const schemas = [breadcrumbSchema, faqSchema].filter(Boolean);
---
<BaseLayout title={title} description={description} canonicalPath={normalizedCanonicalPath}>
  {schemas.length ? (
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({ "@context": "https://schema.org", "@graph": schemas })}
    />
  ) : null}
  <section class="card hero">
    <h1>{title}</h1>
    <p>{intro}</p>
    <div class="btn-row" style="margin-top:12px; align-items:center">
      <button class="btn" type="button" id="copy-share-link">Copy share link</button>
      <span class="muted" id="copy-share-link-status" aria-live="polite" style="font-size:13px"></span>
    </div>
  </section>

  <script is:inline type="text/javascript">
    (function () {
      var btn = document.getElementById("copy-share-link");
      var status = document.getElementById("copy-share-link-status");
      if (!btn) return;
      function setStatus(msg) {
        if (!status) return;
        status.textContent = msg || "";
      }
      btn.addEventListener("click", function () {
        try {
          var url = window.location.href;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(url)
              .then(function () {
                setStatus("Copied");
                setTimeout(function () {
                  setStatus("");
                }, 1200);
              })
              .catch(function () {
                window.prompt("Copy link:", url);
              });
          } else {
            window.prompt("Copy link:", url);
          }
        } catch (e) {}
      });
    })();
  </script>

  <section class="card section">
    <slot />
  </section>

  <section class="section">
    <AdSlot slot={slots.calculatorMid} minHeight={280} />
  </section>

  {examples && examples.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Example scenario</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {examples.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  {includes && includes.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Included</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {includes.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  {excludes && excludes.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Not included</h2>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        {excludes.map((line) => (
          <li>{line}</li>
        ))}
      </ul>
    </section>
  ) : null}

  <section class="card section prose">
    <h2 style="margin-top:0">How we calculate</h2>
    <ul class="muted" style="margin:8px 0 0; padding-left:18px">
      {how.map((line) => (
        <li>{line}</li>
      ))}
    </ul>
  </section>

  <section class="card section prose">
    <h2 style="margin-top:0">FAQ</h2>
    {faqs.map((f) => (
      <details class="card2" style="padding:12px; margin:10px 0">
        <summary style="cursor:pointer; font-weight:800">{f.q}</summary>
        <div class="muted" style="margin-top:8px">{f.a}</div>
      </details>
    ))}
  </section>

  {related && related.length ? (
    <section class="card section prose">
      <h2 style="margin-top:0">Related tools</h2>
      <div class="btn-row" style="margin-top:0">
        {related.map((r) => (
          <a class="btn" href={withTrailingSlash(r.href)}>
            {r.label}
          </a>
        ))}
      </div>
    </section>
  ) : null}

  <section class="section">
    <AdSlot slot={slots.calculatorBottom} minHeight={280} />
  </section>

  <section class="card section prose">
    <h2 style="margin-top:0">Disclaimer</h2>
    <p class="muted" style="margin:0">
      Educational use only. Not legal, financial, or professional advice. Results are estimates based on the inputs and
      assumptions shown on this page. Verify pricing and limits with your providers and documentation.
    </p>
    <p class="muted" style="margin:10px 0 0">Last updated: {lastUpdated}</p>
  </section>
</BaseLayout>
