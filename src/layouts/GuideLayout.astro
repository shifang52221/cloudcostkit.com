---
import BaseLayout from "./BaseLayout.astro";
import { SITE } from "../config/site";
import { withTrailingSlash } from "../lib/url";
import { GUIDES } from "../lib/guides.generated";
import { TOOLS } from "../lib/tools";

type Props = {
  title: string;
  description: string;
  canonicalPath: string;
  lastUpdated: string;
  faqs?: { q: string; a: string }[];
};

const { title, description, canonicalPath, lastUpdated, faqs } = Astro.props;
const siteUrl = Astro.site ? Astro.site.toString() : SITE.url;
const normalizedCanonicalPath = withTrailingSlash(canonicalPath);
const canonical = new URL(normalizedCanonicalPath, siteUrl).toString();
const guideIndexUrl = new URL("/guides/", siteUrl).toString();

const breadcrumbSchema = {
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", siteUrl).toString() },
    { "@type": "ListItem", position: 2, name: "Guides", item: guideIndexUrl },
    { "@type": "ListItem", position: 3, name: title, item: canonical },
  ],
};

const articleSchema = {
  "@type": "Article",
  headline: title,
  description,
  dateModified: lastUpdated,
  mainEntityOfPage: canonical,
  publisher: { "@type": "Organization", name: SITE.name, url: SITE.url },
};

const faqSchema =
  faqs && faqs.length
    ? {
        "@type": "FAQPage",
        url: canonical,
        mainEntity: faqs.map((f) => ({
          "@type": "Question",
          name: f.q,
          acceptedAnswer: { "@type": "Answer", text: f.a },
        })),
      }
    : null;

const currentGuide = GUIDES.find((g) => g.canonicalPath === canonicalPath) ?? null;

function tokenize(input: string) {
  const stop = new Set([
    "a",
    "an",
    "and",
    "are",
    "as",
    "at",
    "by",
    "cost",
    "costs",
    "estimate",
    "estimating",
    "estimation",
    "for",
    "from",
    "how",
    "in",
    "is",
    "it",
    "of",
    "on",
    "or",
    "pricing",
    "to",
    "what",
    "with",
  ]);

  return Array.from(
    new Set(
      String(input || "")
        .toLowerCase()
        .split(/[^a-z0-9]+/g)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3 && !stop.has(t)),
    ),
  );
}

const currentTokens = currentGuide ? tokenize(`${currentGuide.slug} ${title}`) : tokenize(`${canonicalPath} ${title}`);
const currentTopics = currentGuide?.topics ?? [];

function overlapCount(a: string[], b: string[]) {
  if (!a.length || !b.length) return 0;
  const set = new Set(a);
  let count = 0;
  for (const item of b) if (set.has(item)) count++;
  return count;
}

const relatedGuides = currentGuide
  ? GUIDES.filter((g) => g.canonicalPath !== currentGuide.canonicalPath)
      .map((g) => {
        const tokenOverlap = overlapCount(currentTokens, tokenize(`${g.slug} ${g.title}`));
        const topicOverlap = overlapCount(currentTopics, g.topics ?? []);
        const sameCategory = g.category === currentGuide.category ? 1 : 0;
        const score = sameCategory * 3 + topicOverlap * 2 + tokenOverlap;
        return { guide: g, score };
      })
      .filter((x) => x.score > 0)
      .sort((a, b) => b.score - a.score || a.guide.title.localeCompare(b.guide.title))
      .slice(0, 6)
      .map((x) => x.guide)
  : [];

const topicToTools: Record<string, string[]> = {
  egress: [
    "data-egress-cost-calculator",
    "api-response-size-transfer-calculator",
    "vpc-data-transfer-cost-calculator",
    "cross-region-transfer-cost-calculator",
  ],
  cdn: ["cdn-cost-calculator", "cdn-bandwidth-cost-calculator", "cdn-request-cost-calculator"],
  logging: [
    "log-cost-calculator",
    "log-ingestion-cost-calculator",
    "log-retention-storage-cost-calculator",
    "log-search-scan-cost-calculator",
  ],
  metrics: ["metrics-timeseries-cost-calculator", "cloudwatch-metrics-cost-calculator", "aws-cloudwatch-alarms-cost-calculator"],
  kubernetes: ["kubernetes-cost-calculator", "kubernetes-node-cost-calculator", "kubernetes-observability-cost-calculator"],
  requests: ["rps-to-monthly-requests-calculator", "api-request-cost-calculator", "cdn-request-cost-calculator"],
};

const desiredToolSlugs = Array.from(
  new Set(
    (currentTopics.length ? currentTopics : ["egress", "logging", "cdn"])
      .flatMap((t) => topicToTools[t] ?? [])
      .filter(Boolean),
  ),
);

const relatedTools = desiredToolSlugs
  .map((slug) => TOOLS.find((t) => t.slug === slug))
  .filter((t): t is (typeof TOOLS)[number] => Boolean(t))
  .slice(0, 6);
---
<BaseLayout title={title} description={description} canonicalPath={normalizedCanonicalPath}>
  <script
    type="application/ld+json"
    is:inline
    set:html={
      JSON.stringify({
        "@context": "https://schema.org",
        "@graph": [breadcrumbSchema, articleSchema, faqSchema].filter(Boolean),
      })
    }
  />
  <article class="card section prose">
    <h1 style="margin-top:0">{title}</h1>
    <slot />

    {relatedGuides.length ? (
      <>
        <hr style="border:0; height:1px; background: rgba(255,255,255,0.10); margin: 18px 0" />
        <h2 style="margin-top:0">Related guides</h2>
        <div class="grid">
          {relatedGuides.map((g) => (
            <a class="card2 tool col-6" href={withTrailingSlash(g.canonicalPath)}>
              <div class="tool-title">{g.title}</div>
              <div class="tool-desc">{g.description}</div>
            </a>
          ))}
        </div>
      </>
    ) : null}

    {relatedTools.length ? (
      <>
        <hr style="border:0; height:1px; background: rgba(255,255,255,0.10); margin: 18px 0" />
        <h2 style="margin-top:0">Related calculators</h2>
        <div class="grid">
          {relatedTools.map((t) => (
            <a class="card2 tool col-6" href={withTrailingSlash(`/calculators/${t.slug}`)}>
              <div class="tool-title">{t.title}</div>
              <div class="tool-desc">{t.description}</div>
            </a>
          ))}
        </div>
      </>
    ) : null}

    {faqs && faqs.length ? (
      <>
        <hr style="border:0; height:1px; background: rgba(255,255,255,0.10); margin: 18px 0" />
        <h2 style="margin-top:0">FAQ</h2>
        {faqs.map((f) => (
          <details class="card2" style="padding:12px; margin:10px 0">
            <summary style="cursor:pointer; font-weight:800">{f.q}</summary>
            <div class="muted" style="margin-top:8px">{f.a}</div>
          </details>
        ))}
      </>
    ) : null}

    <hr style="border:0; height:1px; background: rgba(255,255,255,0.10); margin: 18px 0" />
    <div class="muted">Last updated: {lastUpdated}</div>
  </article>
</BaseLayout>
